<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cancioneiro Pandereta</title>
    
    <!-- Iconos -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/125/125032.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/125/125032.png">

    <style>
        body { margin: 0; background-color: #f8fafc; font-family: system-ui, sans-serif; }
        #root { height: 100vh; display: flex; flex-direction: column; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #4f46e5; font-weight: bold; flex-direction: column; gap: 20px; }
        .error-box { padding: 20px; background: #fee2e2; color: #991b1b; margin: 20px; border-radius: 10px; font-family: monospace; font-size: 12px; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Estilos App */
        .paper-texture { background-color: #fdfbf7; color: #1c1917; }
        .font-hand { font-family: 'Times New Roman', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .wave-bar { width: 6px; background-color: #6366f1; border-radius: 99px; animation: wave 1s ease-in-out infinite; }
        .wave-bar:nth-child(odd) { animation-duration: 0.6s; background-color: #818cf8; }
        .wave-bar:nth-child(2n) { animation-duration: 1.1s; background-color: #4f46e5; }
        @keyframes wave { 0%, 100% { height: 10%; } 50% { height: 100%; } }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>

    <!-- 1. Cargar React y Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 2. Otras Librer칤as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="spinner"></div>
            <div>Cargando Cancioneiro...</div>
            <div id="error-msg" class="error-box"></div>
        </div>
    </div>

    <!-- Script de Captura de Errores -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorBox = document.getElementById('error-msg');
            errorBox.style.display = 'block';
            errorBox.innerText = 'Error: ' + message + '\nL칤nea: ' + lineno;
        };
    </script>

    <!-- C칍DIGO DE LA APP -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Componente Icono
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: "block", "stroke-width": 2 } });
                }
            }, [name]);
            return <span ref={ref} className={`flex items-center justify-center ${className}`} />;
        };

        const CATEGORIES = ["Mui침eira", "Jota", "Pasodoble", "Rumba", "Alal치", "Cantiga", "Maneob", "Varios"];

        const INITIAL_SONGS = [
            { id: '1', title: 'Mui침eira de Chantada', category: 'Mui침eira', date: 'Repertorio', lyrics: "Esta noite hai unha f칤a\nNo lugar de Requeixo\nVaite lavar morena\nVaite lavar que cheira" },
            { id: '2', title: 'A Rianxeira', category: 'Pasodoble', date: 'Repertorio', lyrics: "A virxe de Guadalupe\nCando vai pola ribeira\nDescalci침a pola area\nMirando para Rianxo" }
        ];

        const App = () => {
            const [view, setView] = useState('library');
            const [songs, setSongs] = useState([]);
            const [currentSong, setCurrentSong] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [filterCategory, setFilterCategory] = useState("Todas");
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [isFullScreen, setIsFullScreen] = useState(false);
            const [isListening, setIsListening] = useState(false); 
            const [liveTranscript, setLiveTranscript] = useState("");
            const [isRecordingAudio, setIsRecordingAudio] = useState(false); 
            const [matchFound, setMatchFound] = useState(null);
            
            const fileInputRef = useRef(null);
            const recognitionRef = useRef(null);
            const audioRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('cancioneiro_data_v2');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setSongs(parsed.length > 0 ? parsed : INITIAL_SONGS);
                    } else {
                        setSongs(INITIAL_SONGS);
                    }
                } catch(e) { setSongs(INITIAL_SONGS); }
            }, []);

            useEffect(() => {
                if (songs.length > 0) localStorage.setItem('cancioneiro_data_v2', JSON.stringify(songs));
            }, [songs]);

            // Utils
            const detectMetadata = (text) => {
                const normalizedText = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                let detectedCat = "Varios";
                for (const cat of CATEGORIES) {
                    const normCat = cat.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    if (normalizedText.includes(normCat)) { detectedCat = cat; break; }
                }
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                let detectedTitle = lines.length > 0 ? lines[0] : "Canci칩n Nueva";
                if (detectedTitle.length < 3 && lines.length > 1) detectedTitle = lines[1];
                if (detectedTitle.length > 40) detectedTitle = detectedTitle.substring(0, 30) + "...";
                return { category: detectedCat, title: detectedTitle };
            };

            // Identificar
            const startListening = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { alert("Navegador no compatible con reconocimiento de voz."); return; }
                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'gl-ES';
                recognition.onstart = () => { setIsListening(true); setLiveTranscript(""); setMatchFound(null); };
                recognition.onresult = (event) => {
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) interim += event.results[i][0].transcript;
                    setLiveTranscript(interim);
                    const search = interim.toLowerCase().trim();
                    if (search.length > 4) {
                        const match = songs.find(s => s.lyrics.toLowerCase().includes(search) || s.title.toLowerCase().includes(search));
                        if (match) setMatchFound(match);
                    }
                };
                recognition.onend = () => { if (isListening && !matchFound) try{recognition.start()}catch(e){} else setIsListening(false); };
                recognitionRef.current = recognition;
                try { recognition.start(); } catch(e) { alert("Error al iniciar micro."); }
            };

            const stopListening = () => { setIsListening(false); if (recognitionRef.current) recognitionRef.current.stop(); };

            const createFromAudio = () => {
                stopListening();
                const metadata = detectMetadata(liveTranscript);
                const newEntry = { id: Date.now().toString(), title: metadata.title, category: metadata.category, lyrics: liveTranscript, date: new Date().toLocaleDateString(), audioUrl: null };
                setCurrentSong(newEntry);
                setView('editor');
            };

            // Grabadora
            const toggleAudioRecording = async () => {
                if (isRecordingAudio) {
                    if (audioRecorderRef.current && audioRecorderRef.current.state !== 'inactive') audioRecorderRef.current.stop();
                    setIsRecordingAudio(false);
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream);
                    audioChunksRef.current = [];
                    recorder.ondataavailable = e => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(blob);
                        const updatedSong = { ...currentSong, audioUrl: audioUrl };
                        setCurrentSong(updatedSong);
                        setSongs(prev => prev.map(s => s.id === currentSong.id ? updatedSong : s));
                        stream.getTracks().forEach(track => track.stop());
                    };
                    recorder.start();
                    audioRecorderRef.current = recorder;
                    setIsRecordingAudio(true);
                } catch (err) { alert("Error al grabar: " + err.message); }
            };

            // OCR
            const processImage = (file) => {
                setIsProcessing(true); setProgress(0);
                const imageUrl = URL.createObjectURL(file);
                Tesseract.recognize(imageUrl, 'spa', { logger: m => m.status === 'recognizing text' && setProgress(parseInt(m.progress * 100)) })
                .then(({ data: { text } }) => {
                    let clean = text.replace(/\|/g, '').split('\n').filter(l => l.trim().length > 0).join('\n');
                    const metadata = detectMetadata(clean);
                    const newEntry = { id: Date.now().toString(), title: metadata.title, category: metadata.category, lyrics: clean, image: imageUrl, date: new Date().toLocaleDateString() };
                    setCurrentSong(newEntry); setIsProcessing(false); setView('editor');
                }).catch(err => { alert("Error OCR."); setIsProcessing(false); });
            };

            const handleFile = (e) => { if(e.target.files?.[0]) processImage(e.target.files[0]); };
            const saveSong = (songData) => {
                if (songs.some(s => s.id === songData.id)) setSongs(songs.map(s => s.id === songData.id ? songData : s));
                else setSongs([songData, ...songs]);
                if (view === 'editor') setView('library');
            };
            const deleteSong = (id) => { if (confirm("쮹orrar?")) { setSongs(songs.filter(s => s.id !== id)); setView('library'); }};
            const filteredSongs = songs.filter(s => {
                const q = searchQuery.toLowerCase();
                return (s.title.toLowerCase().includes(q) || s.lyrics.toLowerCase().includes(q)) && (filterCategory === "Todas" || s.category === filterCategory);
            });

            // VISTAS
            if (view === 'library') {
                return (
                    <div className="bg-slate-50 text-slate-900 font-sans h-full flex flex-col relative">
                        {isListening && (
                            <div className="fixed inset-0 bg-indigo-900/95 z-50 flex flex-col items-center justify-center p-6 text-white backdrop-blur-md animate-in fade-in">
                                <button onClick={stopListening} className="absolute top-12 right-6 p-4 bg-white/10 rounded-full"><Icon name="x" size={24}/></button>
                                <div className="wave-container mb-8">{[...Array(8)].map((_, i) => <div key={i} className="wave-bar"></div>)}</div>
                                <h2 className="text-2xl font-bold mb-2 text-center animate-pulse">Escuchando...</h2>
                                <div className="w-full max-w-md bg-white/10 rounded-xl p-4 mb-6 min-h-[100px] text-center italic text-lg border border-white/10 flex items-center justify-center">"{liveTranscript || "..."}"</div>
                                {matchFound ? (
                                    <div className="bg-green-500 text-white p-6 rounded-2xl w-full max-w-md flex flex-col items-center shadow-2xl animate-bounce">
                                        <p className="text-sm font-bold uppercase opacity-80 mb-1">춰Encontrada!</p>
                                        <p className="font-bold text-2xl mb-4 text-center">{matchFound.title}</p>
                                        <button onClick={() => { stopListening(); setCurrentSong(matchFound); setView('details'); }} className="bg-white text-green-700 px-8 py-3 rounded-full font-bold shadow-sm w-full">Abrir</button>
                                    </div>
                                ) : ( liveTranscript.length > 5 && <button onClick={createFromAudio} className="bg-white text-indigo-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition"><Icon name="plus" size={20} /> Guardar Nueva</button> )}
                            </div>
                        )}

                        <div className="bg-white px-6 pt-4 pb-4 shadow-sm sticky top-0 z-10 border-b border-slate-100">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-xl font-bold flex items-center gap-2 text-slate-800"><span className="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm"><Icon name="music" size={20} /></span> Cancioneiro</h1>
                                <button onClick={startListening} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 border border-indigo-100 shadow-sm"><Icon name="mic" size={16} /> Identificar</button>
                            </div>
                            <input type="text" placeholder="Buscar..." className="w-full pl-4 pr-4 py-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm mb-4" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                            <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                <button onClick={() => setFilterCategory("Todas")} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${filterCategory === "Todas" ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}`}>Todas</button>
                                {CATEGORIES.map(cat => <button key={cat} onClick={() => setFilterCategory(cat)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${filterCategory === cat ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}`}>{cat}</button>)}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 pb-24 grid grid-cols-1 gap-4 content-start">
                            {filteredSongs.map(song => (
                                <div key={song.id} onClick={() => { setCurrentSong(song); setView('details'); }} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-all cursor-pointer">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="text-[10px] uppercase font-bold px-2 py-1 rounded bg-slate-100 text-slate-500">{song.category}</span>
                                        {song.audioUrl && <Icon name="mic" size={12} className="text-red-500" />}
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-2">{song.title}</h3>
                                    <p className="text-sm text-slate-500 line-clamp-2 italic">"{song.lyrics.substring(0, 60).replace(/\n/g, ' ')}..."</p>
                                </div>
                            ))}
                        </div>

                        <button onClick={() => fileInputRef.current.click()} className="fixed bottom-8 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center active:scale-95 transition-all z-20"><Icon name="camera" size={24} /></button>
                        <input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleFile} />
                        
                        {isProcessing && <div className="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm"><h2 className="text-xl font-bold">Procesando... {progress}%</h2></div>}
                    </div>
                );
            }

            if (view === 'editor') {
                return (
                    <div className="bg-white font-sans h-full flex flex-col">
                        <div className="border-b px-4 py-4 flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm">
                            <button onClick={() => setView('library')} className="p-2 text-slate-500"><Icon name="chevron-left" /></button>
                            <span className="font-bold text-slate-800">Editar</span>
                            <button onClick={() => saveSong(currentSong)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-full font-bold text-sm"><Icon name="check" size={16} /> Guardar</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 pb-20">
                            {currentSong.image && <img src={currentSong.image} className="w-full h-48 object-contain bg-slate-100 rounded-lg" />}
                            <input type="text" value={currentSong.title} onChange={(e) => setCurrentSong({...currentSong, title: e.target.value})} className="w-full text-2xl font-bold border-b-2 border-slate-200 py-2 outline-none" />
                            <div className="flex flex-wrap gap-2">{CATEGORIES.map(cat => <button key={cat} onClick={() => setCurrentSong({...currentSong, category: cat})} className={`px-3 py-1 rounded-lg text-xs font-bold border ${currentSong.category === cat ? 'bg-indigo-600 text-white' : 'bg-white text-slate-500'}`}>{cat}</button>)}</div>
                            <textarea value={currentSong.lyrics} onChange={(e) => setCurrentSong({...currentSong, lyrics: e.target.value})} className="w-full h-96 p-4 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-lg leading-relaxed font-hand" />
                        </div>
                    </div>
                );
            }

            if (view === 'details') {
                return (
                    <div className="font-sans bg-[#fdfbf7] h-full flex flex-col">
                        {!isFullScreen && <div className="px-4 py-3 flex justify-between items-center sticky top-0 bg-[#fdfbf7]/95 backdrop-blur z-20 border-b border-black/5 shadow-sm"><button onClick={() => setView('library')} className="p-2 text-slate-600"><Icon name="arrow-left" /></button><div className="flex gap-2"><button onClick={() => setIsFullScreen(true)} className="p-2 text-indigo-600"><Icon name="maximize" size={18} /></button><button onClick={() => setView('editor')} className="p-2 text-slate-600"><Icon name="edit-3" size={18} /></button></div></div>}
                        {isFullScreen && <button onClick={() => setIsFullScreen(false)} className="fixed top-4 right-4 z-50 p-3 bg-black/20 text-white rounded-full"><Icon name="minimize" size={20} /></button>}
                        
                        <div className="flex-1 overflow-y-auto paper-texture w-full h-full pb-32">
                            <div className="max-w-3xl mx-auto px-6 py-12 min-h-screen">
                                <div className="text-center mb-8 border-b-2 border-black/10 pb-8">
                                    <span className="inline-block px-4 py-1.5 mb-4 rounded-full bg-black/5 text-slate-700 text-xs font-bold tracking-widest uppercase">{currentSong.category}</span>
                                    <h1 className="text-3xl font-hand font-bold text-slate-900 leading-tight">{currentSong.title}</h1>
                                    
                                    <div className="mt-8">
                                        {currentSong.audioUrl ? (
                                            <div className="w-full bg-white p-3 rounded-xl shadow border flex flex-col gap-2">
                                                <div className="flex justify-between w-full"><span className="text-xs font-bold text-slate-400">CLASE GRABADA</span><button onClick={() => {if(confirm("쮹orrar?")) { const u = {...currentSong, audioUrl: null}; setCurrentSong(u); setSongs(songs.map(s => s.id === u.id ? u : s)); }}} className="text-red-400"><Icon name="trash-2" size={14}/></button></div>
                                                <audio src={currentSong.audioUrl} controls className="w-full h-8" />
                                            </div>
                                        ) : (
                                            <button onClick={toggleAudioRecording} className={`px-6 py-3 rounded-full font-bold text-sm flex items-center gap-2 shadow-lg mx-auto transition-all ${isRecordingAudio ? 'bg-red-600 text-white recording-pulse' : 'bg-white text-slate-700 border'}`}>
                                                {isRecordingAudio ? 'DETENER GRABACI칍N' : '游댮 GRABAR CLASE'}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                <div className="whitespace-pre-wrap text-slate-900 text-xl leading-loose font-hand px-2">{currentSong.lyrics}</div>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
